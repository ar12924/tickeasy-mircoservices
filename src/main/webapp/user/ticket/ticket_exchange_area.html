<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TickEasy - ËΩâÁ•®Â∞àÂçÄ</title>
    <!-- Bulma CSS Framework -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.0/css/bulma.min.css">
    <link rel="stylesheet" href="../../common/vendors/fontawesome-free-6.7.2-web/js/fontawesome.min.js">
    <!-- ÂÖ±Áî®ÁµÑ‰ª∂Ê®£Âºè -->
    <link rel="stylesheet" href="../layout/nav/nav.css">
    <link rel="stylesheet" href="../layout/footer/footer.css">
    <!-- Â∞àÁî®ÁµÑ‰ª∂Ê®£Âºè -->
    <link rel="stylesheet" href="./css/ticket_exchange_area.css">
</head>

<body>
    <!-- ‰∏ªÂ∞éË¶ΩÂàó nav -->
    <nav class="navbar" role="navigation" aria-label="main navigation">
        <!-- nav.html ÂÖßÂÆπÂ∞áÁî± nav.js ÂãïÊÖãËºâÂÖ• -->
    </nav>

    <!-- ‰∏ªÂÖßÂÆπÂçÄÂ°ä -->
    <main class="main-content">
        <div id="app">
            <!-- Ê¥ªÂãïÂ∞éËà™ÂçÄÂ°ä -->
            <div class="event-navigation">
                <div class="event-back">
                    <a href="#" @click.prevent="goBackToEvent"><span class="arrow-back">‚Äπ</span> {{ eventName ||
                        'ËºâÂÖ•‰∏≠...' }}</a>
                </div>
                <div class="event-tabs">
                    <a href="#" @click.prevent="goToEventInfo" class="tab-link">Ê¥ªÂãïË≥áË®ä</a>
                    <a href="#transfer" class="tab-link active">ËΩâÁ•®Â∞àÂçÄ</a>
                </div>
            </div>

            <!-- ËΩâÁ•®Â∞àÂçÄÂÖßÂÆπ -->
            <div class="exchange-area">
                <h1 class="exchange-title">ËΩâÁ•®Â∞àÂçÄ</h1>

                <!-- ËºâÂÖ•‰∏≠ÁãÄÊÖã -->
                <div v-if="isLoading" class="loading-container">
                    <div class="loading-spinner"></div>
                    <p>ËºâÂÖ•‰∏≠ÔºåË´ãÁ®çÂÄô...</p>
                </div>

                <!-- ÈåØË™§Ë®äÊÅØ -->
                <div v-if="errorMessage && !isLoading" class="error-message">
                    <p>{{ errorMessage }}</p>
                    <button @click="initPage" class="retry-button">ÈáçË©¶</button>
                </div>

                <!-- ÁôºË°®ËΩâÁ•®Ë°®ÂñÆ -->
                <div v-if="!isLoading && !errorMessage && isLoggedIn" class="ticket-form">
                    <h2 class="form-title">ÁôºË°®ËΩâÁ•®</h2>
                    <form @submit.prevent="submitSwapPost">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="user-tickets">‰Ω†ÁöÑÁ•®Âà∏</label>
                                <select v-model="swapForm.ticketId" id="user-tickets" class="form-control form-input"
                                    required>
                                    <option value="">Ë´ãÈÅ∏ÊìáÁ•®Âà∏</option>
                                    <option v-for="ticket in userTickets" :key="ticket.ticketId"
                                        :value="ticket.ticketId">
                                        {{ formatTicketDisplay(ticket) }}
                                    </option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="wanted-ticket">Â∏åÊúõ‰∫§ÊèõÁöÑÁ•®ÂçÄ</label>
                                <input v-model="swapForm.wantedTicketType" type="text" id="wanted-ticket"
                                    class="form-control form-input" placeholder="VIPÂçÄ" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <textarea v-model="swapForm.description" id="ticket-description" class="form-control"
                                rows="3" placeholder="Ë£úÂÖÖË™™ÊòéÔºàÈÅ∏Â°´Ôºâ" required></textarea>
                        </div>
                        <div class="form-buttons">
                            <button type="submit" class="submit-button" :disabled="isSubmitting">
                                {{ isSubmitting ? 'Áôº‰Ωà‰∏≠...' : 'ÁôºËµ∑ËΩâÁ•®' }}
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Êú™ÁôªÂÖ•ÊèêÁ§∫ -->
                <div v-if="!isLoading && !errorMessage && !isLoggedIn" class="login-prompt">
                    <p>Ë´ãÂÖàÁôªÂÖ•ÊâçËÉΩÁôºË°®ËΩâÁ•®Ë≤ºÊñá</p>
                    <button @click="goToLogin" class="submit-button">ÂâçÂæÄÁôªÂÖ•</button>
                </div>

                <!-- ËΩâÁ•®ÂàóË°® -->
                <div v-if="!isLoading && !errorMessage">
                    <div v-if="swapPosts.length === 0" class="no-posts">
                        <p>ÁõÆÂâçÊ≤íÊúâËΩâÁ•®Ë≤ºÊñá</p>
                    </div>
                    <div v-else>
                        <div v-for="post in swapPosts" :key="post.postId" class="ticket-listing">
                            <div class="user-content">
                                <div class="user-info">
                                    <div class="user-avatar">
                                        <img v-if="post.member && getMemberPhotoUrl(post.member)"
                                            :src="getMemberPhotoUrl(post.member)" :alt="post.member.nickName"
                                            @error="handleImageError($event, post.member)" style="display: block;">
                                        <div v-else class="avatar-placeholder">{{ getAvatarText(getMemberNickName(post))
                                            }}</div>
                                    </div>
                                    <div class="user-details">
                                        <div class="user-name">{{ getMemberNickName(post) }}</div>
                                        <div class="user-role">{{ getRelativeTime(post) }}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="ticket-info">
                                <div class="ticket-label" :class="{ 'ticket-unavailable': post.status === 'ËΩâÁ•®Â∑≤ÂÆåÊàê' }">
                                    {{ post.status || 'ËΩâÁ•®ÈÄ≤Ë°å‰∏≠' }}
                                </div>
                            </div>
                            <div class="ticket-exchange-section">
                                <div class="ticket-exchange-info">
                                    <div class="exchange-item">
                                        <span class="exchange-label">ÊåÅÊúâÁ•®Âà∏Ôºö</span>
                                        <span class="exchange-value">{{ getTicketCategoryName(post) }} (NT$ {{
                                            formatPrice(getTicketPrice(post)) }})</span>
                                    </div>
                                    <div class="exchange-item">
                                        <span class="exchange-label">Â∏åÊúõ‰∫§ÊèõÔºö</span>
                                        <span class="exchange-value">{{ extractWantedTicketType(post.postDescription)
                                            }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="ticket-comment">
                                {{ post.postDescription }}
                            </div>
                            <div class="contact-button-section">
                                <button v-if="!isMyPost(post) && isLoggedIn && !post.showCommentForm"
                                    @click="showCommentForm(post)" class="contact-button">ÊàëË¶ÅÊèõÁ•®</button>
                                <button v-else-if="!isLoggedIn" @click="goToLogin" class="contact-button">ÁôªÂÖ•ÂæåÊèõÁ•®</button>
                                <button v-else-if="isMyPost(post)" @click="deletePost(post.postId)"
                                    class="contact-button delete-button">Âà™Èô§Ë≤ºÊñá</button>
                                <button v-if="post.showCommentForm" @click="hideCommentForm(post)"
                                    class="contact-button cancel-button">ÂèñÊ∂à</button>
                            </div>

                            <!-- ÊèõÁ•®ÁïôË®ÄË°®ÂñÆ -->
                            <div v-if="post.showCommentForm" class="comment-form-section">
                                <h4>ÊèõÁ•®ÁïôË®Ä</h4>
                                <form @submit.prevent="submitComment(post)">
                                    <div class="form-group">
                                        <label>ÈÅ∏ÊìáÊÇ®Ë¶Å‰∫§ÊèõÁöÑÁ•®Âà∏</label>
                                        <select v-model="post.commentForm.ticketId" class="form-control" required>
                                            <option value="">Ë´ãÈÅ∏ÊìáÁ•®Âà∏</option>
                                            <option v-for="ticket in post.commentForm.availableTickets || userTickets"
                                                :key="ticket.ticketId" :value="ticket.ticketId">
                                                {{ formatTicketDisplay(ticket) }}
                                            </option>
                                        </select>
                                        <p v-if="post.commentForm.availableTickets && post.commentForm.availableTickets.length === 0"
                                            class="help-text">
                                            ÊÇ®Ê≤íÊúâÊ≠§Ê¥ªÂãïÁöÑÂèØÁî®Á•®Âà∏ÈÄ≤Ë°å‰∫§Êèõ
                                        </p>
                                    </div>
                                    <div class="form-group">
                                        <label>ÁïôË®ÄÂÖßÂÆπ</label>
                                        <textarea v-model="post.commentForm.description" class="form-control" rows="4"
                                            placeholder="Ë´ãË™™ÊòéÊÇ®ÁöÑÊèõÁ•®ÈúÄÊ±Ç..." required></textarea>
                                    </div>
                                    <div class="form-buttons">
                                        <button type="submit" class="submit-button" :disabled="post.commentSubmitting">
                                            {{ post.commentSubmitting ? 'ÈÄÅÂá∫‰∏≠...' : 'ÈÄÅÂá∫ÁïôË®Ä' }}
                                        </button>
                                    </div>
                                </form>
                            </div>

                            <!-- ÁïôË®ÄÊåâÈàï -->
                            <div class="comments-toggle">
                                <button @click="toggleComments(post.postId)" class="toggle-comments-button">
                                    {{ post.showComments ? 'Èö±ËóèÁïôË®Ä' : 'È°ØÁ§∫ÁïôË®Ä' }}
                                    <span v-if="post.commentCount">({{ post.commentCount }})</span>
                                </button>
                            </div>

                            <!-- üîß ‰øÆÊîπÔºöÁïôË®ÄÂçÄÂ°ä - Á∞°ÂåñÁÇ∫3ÁãÄÊÖãÊìç‰ΩúÊåâÈàï -->
                            <div v-if="post.showComments" class="comments-section">
                                <div v-if="post.comments && post.comments.length > 0">
                                    <div v-for="comment in post.comments" :key="comment.commentId" class="comment-item">
                                        <div class="comment-user">
                                            <div class="user-avatar small">
                                                <img v-if="comment.member && getMemberPhotoUrl(comment.member)"
                                                    :src="getMemberPhotoUrl(comment.member)"
                                                    :alt="comment.member.nickName"
                                                    @error="handleImageError($event, comment.member)"
                                                    style="display: block;">
                                                <div v-else class="avatar-placeholder">
                                                    {{ getAvatarText(getCommentMemberNickName(comment)) }}
                                                </div>
                                            </div>
                                            <div class="comment-details">
                                                <span class="comment-user-name">{{ getCommentMemberNickName(comment)
                                                    }}</span>
                                                <span class="comment-time">{{ getCommentRelativeTime(comment) }}</span>
                                                <span class="comment-status"
                                                    :class="getStatusClass(comment.swappedStatus)">
                                                    {{ getCommentStatusText(comment) }}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="comment-content">
                                            <p>{{ comment.commentDescription }}</p>
                                            <div class="comment-ticket-info">
                                                Êèê‰æõÁ•®Âà∏: {{ getCommentTicketCategoryName(comment) }} (NT$ {{
                                                formatPrice(getCommentTicketPrice(comment)) }})
                                            </div>
                                        </div>
                                        
                                        <!-- üîß ‰øÆÊîπÔºöÁ∞°ÂåñÁÇ∫3ÁãÄÊÖãÁöÑÊìç‰ΩúÊåâÈàï -->
                                        <div v-if="isLoggedIn" class="comment-actions">
                                            <!-- ÁãÄÊÖã0ÔºöÂæÖÊèõÁ•® -->
                                            <template v-if="comment.swappedStatus === 0">
                                                <!-- üîß ‰øÆÊîπÔºöË≤ºÊñáÁôºËµ∑ÊñπÁõ¥Êé•ÂÆåÊàê‰∫§ÊèõÊåâÈàï -->
                                                <button v-if="canAcceptAndComplete(post, comment)"
                                                        @click="acceptAndCompleteExchange(comment.commentId)"
                                                        class="status-button accept">
                                                    Êé•ÂèóË´ãÊ±Ç
                                                </button>
                                                
                                                <!-- ÈõôÊñπÔºöÂèñÊ∂àÊåâÈàï -->
                                                <button v-if="canCancel(post, comment)"
                                                        @click="cancelSwapRequest(comment.commentId)"
                                                        class="status-button cancel">
                                                    ÂèñÊ∂à
                                                </button>
                                            </template>
                                            
                                            <!-- üîß ÁßªÈô§ÔºöÁãÄÊÖã1ÁöÑËôïÁêÜÔºà‰∏çÂÜç‰ΩøÁî®Ôºâ -->
                                            
                                            <!-- ÁãÄÊÖã2ÔºöÂ∑≤ÂÆåÊàê - ÁÑ°Êìç‰ΩúÊåâÈàï -->
                                            <template v-if="comment.swappedStatus === 2">
                                                <div class="status-info completed">
                                                    <i class="status-icon">‚úì</i>
                                                    <span>‰∫§ÊèõÂ∑≤ÂÆåÊàê</span>
                                                </div>
                                            </template>
                                            
                                            <!-- ÁãÄÊÖã3ÔºöÂ∑≤ÂèñÊ∂à - ÁÑ°Êìç‰ΩúÊåâÈàï -->
                                            <template v-if="comment.swappedStatus === 3">
                                                <div class="status-info cancelled">
                                                    <i class="status-icon">‚úï</i>
                                                    <span>Â∑≤ÂèñÊ∂à</span>
                                                </div>
                                            </template>
                                        </div>
                                        
                                        <!-- üîß ‰øÆÊîπÔºöÊú™ÁôªÂÖ•Áî®Êà∂ÁöÑÊèêÁ§∫ -->
                                        <div v-else-if="comment.swappedStatus === 0" 
                                             class="comment-actions">
                                            <button @click="goToLogin" class="status-button login">ÁôªÂÖ•ÂæåÊìç‰Ωú</button>
                                        </div>
                                    </div>
                                </div>
                                <div v-else class="no-comments">
                                    Êö´ÁÑ°ÁïôË®Ä
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- È†ÅËÖ≥ footer -->
    <footer>
        <!-- footer.html ÂÖßÂÆπÂ∞áÁî± footer.js ÂãïÊÖãËºâÂÖ• -->
    </footer>

    <!-- jQuery -->
    <script src="../../common/vendors/jquery-3.7.1.min.js"></script>
    <!-- ÂºïÂÖ•Ëá™ÂÆöÁæ©JavaScript -->
    <script type="module" src="./js/ticket_exchange_area.js"></script>
</body>

</html>