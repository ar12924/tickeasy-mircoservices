<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>活動列表</title>
  <!--Primary Meta Tags-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="title" content="TickEasy | 活動列表" />
  <meta name="author" content="TIA203-G2" />
  <meta name="description"
    content="TickEasy is build by Free Bootstrap 5 Admin Dashboard, 30 example pages using Vanilla JS." />
  <meta name="keywords" content="TickEasy, ticket, concert, ticket admin dashboard" />
  <!--Fonts-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css"
    integrity="sha256-tXJfXfp6Ewt1ilPzLDtQnJV4hclT9XuaZUKyUvmyr+Q=" crossorigin="anonymous" />
  <!--Third Party Plugin(OverlayScrollbars)-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.10.1/styles/overlayscrollbars.min.css"
    integrity="sha256-tZHrRjVqNSRyWg2wbppGnT833E/Ys0DHWGwT04GiqQg=" crossorigin="anonymous" />
  <!--Third Party Plugin(Bootstrap Icons)-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    integrity="sha256-9kPW/n5nn53j4WMRYAxe9c1rCY96Oogo/MKSVdKzPmI=" crossorigin="anonymous" />
  <!--Required Plugin(AdminLTE)-->
  <link rel="stylesheet" href="common/css/adminlte.css" />
  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/2.2.2/css/dataTables.bootstrap5.css" />
</head>

<body class="layout-fixed sidebar-expand-lg bg-body-tertiary">
  <div class="app-wrapper">
    <nav class="app-header navbar navbar-expand bg-body">
      <div class="container-fluid">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" data-lte-toggle="sidebar" href="#" role="button">
              <i class="bi bi-list"></i>
            </a>
          </li>
          <li class="nav-item d-none d-md-block">
            <a href="index.html" class="nav-link">Home</a>
          </li>
        </ul>
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="#" data-lte-toggle="fullscreen">
              <i data-lte-icon="maximize" class="bi bi-arrows-fullscreen"></i>
              <i data-lte-icon="minimize" class="bi bi-fullscreen-exit" style="display: none"></i>
            </a>
          </li>
          <li class="nav-item dropdown user-menu">
            <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">
              <img src="common/assets/img/user2-128x128.png" class="user-image rounded-circle shadow"
                alt="User Image" />
              <span class="d-none d-md-inline" id="sidebar-username">Alexander Pierce</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-lg dropdown-menu-end">
              <!--begin::User Image-->
              <li class="user-header text-bg-primary">
                <img src="common/assets/img/user2-128x128.png" class="rounded-circle shadow" alt="User Image" />
                <p id="block_username">
                  Alexander Pierce - Web Developer
                  <small>Member since Nov. 2023</small>
                </p>
              </li>

              <li class="user-footer">
                <a href="/maven-tickeasy-v1/user/member/edit.html" class="btn btn-default btn-flat">會員中心</a>
                <a href="#" class="btn btn-default btn-flat float-end" onclick="handleLogout()">登出</a>
              </li>
            </ul>
          </li>
        </ul>
      </div>
    </nav>
    <!-- Sidebar -->
    <aside class="app-sidebar bg-body-secondary shadow" data-bs-theme="dark">
      <div class="sidebar-brand">
        <div class="brand-link">
          <a href="./index.html" class="brand-link">
            <span class="brand-text fs-1">TickEasy</span>
          </a>
          <span class="brand-text fs-7">活動方</span>
        </div>
      </div>
      <div class="sidebar-wrapper">
        <nav class="mt-2">
          <ul class="nav sidebar-menu flex-column" data-lte-toggle="treeview" role="menu" data-accordion="false">
            <li class="nav-header">活動方</li>
            <li class="nav-item">
              <a href="event/CreateEvent.html" class="nav-link">
                <i class="nav-icon bi bi-patch-plus-fill"></i>
                <p>建立活動</p>
              </a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link">
                <i class="nav-icon bi bi-gear-wide-connected"></i>
                <p>活動管理 <i class="nav-arrow bi bi-chevron-right"></i></p>
              </a>
              <ul class="nav nav-treeview">
                <li class="nav-item">
                  <a href="./index.html" class="nav-link">
                    <i class="nav-icon bi bi-list-task"></i>
                    <p>活動列表</p>
                  </a>
                </li>
              </ul>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link">
                <i class="nav-icon bi bi bi-people-fill"></i>
                <p>會員管理 <i class="nav-arrow bi bi-chevron-right"></i></p>
              </a>
              <ul class="nav nav-treeview">
                <li class="nav-item">
                  <a href="./index.html" class="nav-link">
                    <i class="nav-icon bi bi-person-fill-gear"></i>
                    <p>會員設定</p>
                  </a>
                </li>
              </ul>
            </li>
          </ul>
        </nav>
      </div>
    </aside>
    <main class="app-main">
      <div class="app-content-header">
        <div class="container">
          <div class="row">
            <div class="col-sm-6">
              <h2 class="mb-0">活動列表</h2>
            </div>
            <div class="col-sm-6">
              <ol class="breadcrumb float-sm-end">
                <li class="breadcrumb-item">
                  <a href="./index.html">Home</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                  活動列表
                </li>
              </ol>
            </div>
          </div>
        </div>
      </div>
      <div class="app-content">
        <div class="container">
          <div class="row">
            <table id="eventList" class="table table-striped caption-top" style="width: 100%; padding-bottom: 800px">
              <caption>
                <h1>正在舉辦活動</h1>
              </caption>
              <thead>
                <tr>
                  <th>活動名稱</th>
                  <th>活動開始時間</th>
                  <th>狀態</th>
                  <th>編輯</th>
                  <th>檢視</th>
                </tr>
              </thead>
            </table>
          </div>
        </div>
      </div>
    </main>
    <footer class="app-footer">
      <div class="float-end d-none d-sm-inline">TIA203-G2</div>
      <strong>
        Copyright &copy; 2025&nbsp;
        <a href="https://gamma.app/docs/TickEasy-gd84wknpd0a0roz?mode=doc" class="text-decoration-none">TickEasy</a>.
      </strong>
      All rights reserved.
    </footer>
  </div>
  <!-- JS依賴順序：jQuery → Bootstrap → OverlayScrollbars → popperjs → AdminLTE → DataTables → 其他 -->
  <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.10.1/browser/overlayscrollbars.browser.es6.min.js"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
    crossorigin="anonymous"></script>
  <script src="common/js/adminlte.js"></script>
  <script src="https://cdn.datatables.net/2.2.2/js/dataTables.js"></script>
  <script src="https://cdn.datatables.net/2.2.2/js/dataTables.bootstrap5.js"></script>
  <script>

    /**
 * Header 功能管理模組
 * 用於統一管理各頁面的 header 功能
 */
(function() {
    'use strict';

    // 預設頭像路徑
    const DEFAULT_AVATAR = "common/assets/img/user2-128x128.png";

    /**
     * 初始化 Header 功能
     */
    function initHeader() {
        console.log('=== Header 初始化開始 ===');
        updateUserInfo();
        console.log('=== Header 初始化完成 ===');
    }

    /**
     * 更新使用者資訊顯示
     */
    function updateUserInfo() {
        // 從 sessionStorage 讀取使用者資料
        const loggedInNickname = sessionStorage.getItem("loggedInNickname");
        const memberId = sessionStorage.getItem("memberId");

        console.log('讀取 session 資料:', {
            loggedInNickname,
            memberId
        });

        // 更新導航列中的使用者名稱顯示
        const navUserNameSpan = document.querySelector('.app-header .nav-link.dropdown-toggle .d-none.d-md-inline');
        if (navUserNameSpan) {
            navUserNameSpan.textContent = loggedInNickname || 'Guest';
            console.log('更新導航列使用者名稱:', loggedInNickname);
        }

        // 更新下拉選單中的使用者資訊
        const userHeaderP = document.querySelector('.app-header .user-header p');
        if (userHeaderP && loggedInNickname) {
            userHeaderP.innerHTML = `${loggedInNickname}<small>TickEasy 管理平台</small>`;
            console.log('更新下拉選單使用者資訊:', loggedInNickname);
        }

        // 載入使用者頭像
        if (memberId) {
            loadUserAvatar(memberId);
        } else {
            // 沒有 memberId 時使用預設頭像
            setDefaultAvatar();
        }
    }

    /**
     * 載入使用者頭像
     * @param {string} memberId - 會員ID
     */
    function loadUserAvatar(memberId) {
        console.log('開始載入會員頭像, memberId:', memberId);
        
        // 只選擇 header 區域的頭像元素，避免影響頁面內容區域
        const avatarElements = document.querySelectorAll('.app-header .user-image, .app-header .user-header img');
        const avatarUrl = `/maven-tickeasy-v1/api/manager/member/photo/${memberId}`;

        console.log('找到的頭像元素數量:', avatarElements.length);

        // 先設定預設頭像，避免載入期間顯示空白
        setDefaultAvatar();

        // 測試頭像是否存在
        const testImg = new Image();
        
        testImg.onload = function() {
            console.log('會員頭像載入成功');
            // 頭像載入成功，更新所有 header 區域的頭像元素
            avatarElements.forEach((img, index) => {
                img.src = avatarUrl + '?t=' + new Date().getTime();
                img.alt = '會員頭像';
                console.log(`更新第 ${index + 1} 個頭像元素`);
            });
        };
        
        testImg.onerror = function() {
            console.log('會員頭像載入失敗，使用預設頭像');
            // 頭像載入失敗，保持預設頭像
            setDefaultAvatar();
        };
        
        // 開始載入頭像
        testImg.src = avatarUrl + '?timestamp=' + new Date().getTime();
    }

    /**
     * 設定預設頭像
     */
    function setDefaultAvatar() {
        // 只設定 header 區域的預設頭像
        const avatarElements = document.querySelectorAll('.app-header .user-image, .app-header .user-header img');
        avatarElements.forEach((img, index) => {
            img.src = DEFAULT_AVATAR;
            img.alt = '預設頭像';
            console.log(`設定第 ${index + 1} 個預設頭像`);
        });
    }

    /**
     * 處理登出功能
     */
    function handleLogout() {
        if (confirm('確定要登出嗎？')) {
            console.log('開始登出程序');
            
            // 清除 sessionStorage
            sessionStorage.clear();
            console.log('清除 sessionStorage');
            
            // 呼叫登出 API
            fetch('/maven-tickeasy-v1/user/member/logout', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('登出 API 回應:', data);
                if (data.successful) {
                    console.log('登出成功，跳轉到首頁');
                    window.location.href = '/maven-tickeasy-v1/user/buy/index.html';
                } else {
                    console.log('登出 API 失敗，但仍跳轉到首頁');
                    window.location.href = '/maven-tickeasy-v1/user/buy/index.html';
                }
            })
            .catch(error => {
                console.error('登出錯誤:', error);
                console.log('登出出錯，但仍跳轉到首頁');
                window.location.href = '/maven-tickeasy-v1/user/buy/index.html';
            });
        }
    }

    /**
     * DOM 載入完成後初始化
     */
    function initializeHeader() {
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initHeader);
        } else {
            initHeader();
        }
    }

    // 將函數暴露到全域
    window.initHeader = initHeader;
    window.handleLogout = handleLogout;

    // 自動初始化
    initializeHeader();
})();
  </script>
  <!-- 其他功能插件 -->

  <!-- OverlayScrollbars Configure -->
  <script>
    const SELECTOR_SIDEBAR_WRAPPER = ".sidebar-wrapper";
    const Default = {
      scrollbarTheme: "os-theme-light",
      scrollbarAutoHide: "leave",
      scrollbarClickScroll: true,
    };
    document.addEventListener("DOMContentLoaded", function () {
      const sidebarWrapper = document.querySelector(SELECTOR_SIDEBAR_WRAPPER);
      if (
        sidebarWrapper &&
        typeof OverlayScrollbarsGlobal?.OverlayScrollbars !== "undefined"
      ) {
        OverlayScrollbarsGlobal.OverlayScrollbars(sidebarWrapper, {
          scrollbars: {
            theme: Default.scrollbarTheme,
            autoHide: Default.scrollbarAutoHide,
            clickScroll: Default.scrollbarClickScroll,
          },
        });
      }
    });
  </script>
  <!-- index.js 必須在所有依賴之後 -->
  <script src="./index.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      if (window.AdminLTE && window.AdminLTE.Treeview) {
        window.AdminLTE.Treeview.activate(
          document.querySelector('[data-lte-toggle="treeview"]')
        );
      }
    });
  </script>
  <script>
    // 動態帶入 nickname
    document.addEventListener("DOMContentLoaded", function () {
      var nickname = sessionStorage.getItem("loggedInNickname") || "使用者";
      var el = document.getElementById("sidebar-username");
      if (el) el.textContent = nickname;
    });
  </script>
</body>

</html>