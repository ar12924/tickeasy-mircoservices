<!doctype html>
<html lang="en">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>TickEasy | 建立活動</title>

	<!--Primary Meta Tags-->
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<meta name="title" content="TickEasy | 建立活動" />
	<meta name="author" content="TIA203-G2" />
	<meta name="description"
		content="TickEasy is build by Free Bootstrap 5 Admin Dashboard, 30 example pages using Vanilla JS." />
	<meta name="keywords" content="TickEasy, ticket, concert, ticket admin dashboard" />
	<link rel="icon" href="../common/assets/img/Member_icon.ico">
	<!--Fonts-->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css"
		integrity="sha256-tXJfXfp6Ewt1ilPzLDtQnJV4hclT9XuaZUKyUvmyr+Q=" crossorigin="anonymous" />
	<!--Third Party Plugin(OverlayScrollbars)-->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.10.1/styles/overlayscrollbars.min.css"
		integrity="sha256-tZHrRjVqNSRyWg2wbppGnT833E/Ys0DHWGwT04GiqQg=" crossorigin="anonymous" />
	<!--Third Party Plugin(Bootstrap Icons)-->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
		integrity="sha256-9kPW/n5nn53j4WMRYAxe9c1rCY96Oogo/MKSVdKzPmI=" crossorigin="anonymous" />
	<!--Required Plugin(AdminLTE)-->
	<link rel="stylesheet" href="../common/css/adminlte.css" />
	<!-- apexcharts -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.css"
		integrity="sha256-4MX+61mt9NVvvuPjUWdUdyfZfxSB1/Rf9WtqRHgG5S0=" crossorigin="anonymous" />
	<!--Summernote-->
	<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.20/dist/summernote-lite.min.css" rel="stylesheet">
</head>

<body class="layout-fixed sidebar-expand-lg bg-body-tertiary">
	<div class="app-wrapper">
		<nav class="app-header navbar navbar-expand bg-body">
			<div class="container-fluid">
				<ul class="navbar-nav">
					<li class="nav-item"><a class="nav-link" data-lte-toggle="sidebar" href="#" role="button"> <i
								class="bi bi-list"></i>
						</a></li>
					<li class="nav-item d-none d-md-block"><a href="index.html" class="nav-link">Home</a></li>
				</ul>
				<ul class="navbar-nav ms-auto">
					<li class="nav-item"><a class="nav-link" href="#" data-lte-toggle="fullscreen"> <i
								data-lte-icon="maximize" class="bi bi-arrows-fullscreen"></i> <i
								data-lte-icon="minimize" class="bi bi-fullscreen-exit" style="display: none"></i>
						</a></li>
					<li class="nav-item dropdown user-menu"><a href="#" class="nav-link dropdown-toggle"
							data-bs-toggle="dropdown"> <img src="../common/assets/img/user2-128x128.png"
								class="user-image rounded-circle shadow" alt="User Image" /> <span
								class="d-none d-md-inline">Alexander Pierce</span>
						</a>
						<ul class="dropdown-menu dropdown-menu-lg dropdown-menu-end">
							<!--begin::User Image-->
							<li class="user-header text-bg-primary"><img src="../common/assets/img/user2-128x128.png"
									class="rounded-circle shadow" alt="User Image" />
								<p>
									Alexander Pierce - Web Developer <small>Member since
										Nov. 2023</small>
								</p>
							</li>
							<li class="user-body">
								<div class="row">
									<div class="col-6 text-center">
										<a href="#">活動場次</a><br> <a href="#" class="fs-4">1000</a>
									</div>
									<div class="col-6 text-center">
										<a href="#">Friends</a><br> <a href="#" class="fs-4">1000</a>
									</div>
								</div>
							</li>
							<li class="user-footer"><a href="#" class="btn btn-default btn-flat">Profile</a> <a href="#"
									class="btn btn-default btn-flat float-end">Sign out</a></li>
						</ul>
					</li>
				</ul>
			</div>
		</nav>
		<aside class="app-sidebar bg-body-secondary shadow" data-bs-theme="dark">
			<div class="sidebar-brand">
				<div class="brand-link">
					<a href="./index.html" class="brand-link"> <span class="brand-text fs-1">TickEasy</span>
					</a> <span class="brand-text fs-7">活動方</span>
				</div>
			</div>
			<div class="sidebar-wrapper">
				<nav class="mt-2">
					<ul class="nav sidebar-menu flex-column" data-lte-toggle="treeview" role="menu"
						data-accordion="false">
						<li class="nav-header">活動方</li>
						<li class="nav-item"><a href="./event_new.html" class="nav-link"> <i
									class="nav-icon bi bi-patch-plus-fill"></i>
								<p>建立活動</p>
							</a></li>
						<li class="nav-item"><a href="#" class="nav-link"> <i
									class="nav-icon bi bi-gear-wide-connected"></i>
								<p>
									活動管理 <i class="nav-arrow bi bi-chevron-right"></i>
								</p>
							</a>
							<ul class="nav nav-treeview">
								<li class="nav-item"><a href="./index.html" class="nav-link"> <i
											class="nav-icon bi bi-list-task"></i>
										<p>活動列表</p>
									</a></li>
							</ul>
						</li>
						<li class="nav-item"><a href="#" class="nav-link"> <i class="nav-icon bi bi bi-people-fill"></i>
								<p>
									會員管理 <i class="nav-arrow bi bi-chevron-right"></i>
								</p>
							</a>
							<ul class="nav nav-treeview">
								<li class="nav-item"><a href="./index.html" class="nav-link"> <i
											class="nav-icon bi bi-person-fill-gear"></i>
										<p>會員設定</p>
									</a></li>
								<li class="nav-item"><a href="./index.html" class="nav-link"> <i
											class="nav-icon bi bi-shield-lock-fill"></i>
										<p>會員密碼</p>
									</a></li>
							</ul>
						</li>
						<li class="nav-header">平台方</li>
						<li class="nav-item"><a href="#" class="nav-link"> <i
									class="nav-icon bi bi-gear-wide-connected"></i>
								<p>
									活動管理 <i class="nav-arrow bi bi-chevron-right"></i>
								</p>
							</a>
							<ul class="nav nav-treeview">
								<li class="nav-item"><a href="./index.html" class="nav-link"> <i
											class="nav-icon bi bi-calendar3-range-fill"></i>
										<p>活動列表</p>
									</a></li>
								<li class="nav-item"><a href="./index.html" class="nav-link"> <i
											class="nav-icon bi bi-ticket-perforated-fill"></i>
										<p>票券列表</p>
									</a></li>
							</ul>
						</li>
						<li class="nav-item"><a href="#" class="nav-link"> <i class="nav-icon bi bi bi-people-fill"></i>
								<p>
									會員管理 <i class="nav-arrow bi bi-chevron-right"></i>
								</p>
							</a>
							<ul class="nav nav-treeview">
								<li class="nav-item"><a href="./index.html" class="nav-link"> <i
											class="nav-icon bi bi-person-lines-fill"></i>
										<p>會員列表</p>
									</a></li>
								<li class="nav-item"><a href="./index.html" class="nav-link"> <i
											class="nav-icon bi bi-person-heart"></i>
										<p>購票者</p>
									</a></li>
								<li class="nav-item"><a href="./index.html" class="nav-link"> <i
											class="nav-icon bi bi-bookmark-check-fill"></i>
										<p>活動方</p>
									</a></li>
							</ul>
						</li>
						<li class="nav-item"><a href="#" class="nav-link"> <i class="nav-icon bi bi-cone-striped"></i>
								<p>
									平台管理 <i class="nav-arrow bi bi-chevron-right"></i>
								</p>
							</a>
							<ul class="nav nav-treeview">
								<li class="nav-item"><a href="./index.html" class="nav-link"> <i
											class="nav-icon bi bi-check2-square"></i>
										<p>活動單位審核</p>
									</a></li>
								<li class="nav-item"><a href="./index.html" class="nav-link"> <i
											class="nav-icon bi bi-backspace-reverse-fill"></i>
										<p>平台帳號管理</p>
									</a></li>
							</ul>
						</li>
						<li class="nav-item"><a href="#" class="nav-link"> <i
									class="nav-icon bi bi bi-person-hearts"></i>
								<p>
									粉絲交流管理 <i class="nav-arrow bi bi-chevron-right"></i>
								</p>
							</a>
							<ul class="nav nav-treeview">
								<li class="nav-item"><a href="./index.html" class="nav-link"> <i
											class="nav-icon bi bi-list-task"></i>
										<p>討論區列表</p>
									</a></li>
							</ul>
						</li>
					</ul>
				</nav>
			</div>
		</aside>
		<main class="app-main">
			<div class="app-content-header">
				<div class="container-fluid">
					<div class="row">
						<div class="col-sm-6">
							<h3 class="mb-0">檢視 Aespa演唱會</h3>
						</div>
						<div class="col-sm-6">
							<ol class="breadcrumb float-sm-end">
								<li class="breadcrumb-item"><a href="index.html">Home</a></li>
								<li class="breadcrumb-item"><a href="index.html">活動列表</a></li>
								<li class="breadcrumb-item active" aria-current="page">檢視
									Aespa演唱會</li>
							</ol>
						</div>
					</div>
				</div>
			</div>
			<div class="app-content">
				<div class="container-fluid">
					<!-- 標籤頁導航 -->
					<div class="row mb-3">
						<div class="col-12">
							<ul class="nav nav-tabs" id="myTab" role="tablist">
								<li class="nav-item" role="presentation">
									<button class="nav-link active" id="exchange-tab" data-bs-toggle="tab"
										data-bs-target="#exchange" type="button" role="tab" aria-controls="exchange"
										aria-selected="true">換票列表</button>
								</li>
								<li class="nav-item" role="presentation">
									<button class="nav-link" id="ticket-tab" data-bs-toggle="tab"
										data-bs-target="#ticket" type="button" role="tab" aria-controls="ticket"
										aria-selected="false">分票列表</button>
								</li>
							</ul>
						</div>
					</div>

					<!-- 標籤頁內容 -->
					<div class="tab-content" id="myTabContent">
						<!-- 換票列表 -->
						<div class="tab-pane fade show active" id="exchange" role="tabpanel"
							aria-labelledby="exchange-tab">
							<div class="card">
								<div class="card-header">
									<div class="row">
										<div class="col-md-6">
											<h3 class="card-title">換票列表</h3>
										</div>
										<div class="col-md-6 text-end">
											<div class="d-flex justify-content-end align-items-center">
												<label class="me-2 mb-0">目前檢視活動</label>
												<select class="form-select" id="eventSelect" style="width: auto;">
													<option value="">全部活動</option>
													<!-- 選項將由 JavaScript 動態載入 -->
												</select>
											</div>
										</div>
									</div>
								</div>
								<div class="card-body">
									<!-- 搜尋區域 -->
									<form class="mb-4" id="searchForm">
										<div class="row g-3">
											<div class="col-md-6">
												<div class="input-group">
													<span class="input-group-text">搜尋</span>
													<input type="text" class="form-control" id="keywordInput"
														placeholder="請輸入關鍵字">
													<button class="btn btn-outline-secondary" type="button"
														id="searchBtn">
														<i class="bi bi-search"></i>
													</button>
												</div>
											</div>
											<div class="col-md-6">
												<div class="row g-2">
													<div class="col-auto">
														<label class="col-form-label">換票時間</label>
													</div>
													<div class="col">
														<input type="date" class="form-control" id="startDateInput">
													</div>
													<div class="col-auto">
														<span class="col-form-label">~</span>
													</div>
													<div class="col">
														<input type="date" class="form-control" id="endDateInput">
													</div>
												</div>
											</div>
											<div class="col-md-6">
												<div class="row g-2">
													<div class="col-auto">
														<label class="col-form-label">換票狀態：</label>
													</div>
													<div class="col">
														<select class="form-select" id="statusSelect">
															<option value="">全部</option>
															<!-- 選項將由 JavaScript 動態載入 -->
														</select>
													</div>
													<div class="col-auto">
														<button type="button" class="btn btn-outline-secondary"
															id="resetBtn">
															<i class="bi bi-arrow-clockwise"></i> 重置
														</button>
													</div>
												</div>
											</div>
										</div>
									</form>

									<!-- 表格區域 -->
									<div class="table-responsive">
										<table class="table table-bordered table-striped">
											<thead>
												<tr>
													<th>換票ID</th>
													<th>換票方票券ID</th>
													<th>換票方member_id</th>
													<th>被換方票券ID</th>
													<th>被換方member_id</th>
													<th>換票成功時間</th>
													<th>狀態</th>
												</tr>
											</thead>
											<tbody id="exchangeTableBody">
												<!-- 資料將由JavaScript動態載入 -->
											</tbody>
										</table>
									</div>

									<!-- 分頁 -->
									<div class="row">
										<div class="col-12">
											<nav>
												<ul class="pagination justify-content-center" id="paginationContainer">
													<!-- 分頁將由JavaScript動態生成 -->
												</ul>
											</nav>
										</div>
									</div>

									<!-- 返回按鈕 -->
									<div class="row mt-3">
										<div class="col-12 text-end">
											<button type="button" class="btn btn-secondary" id="backBtn">回到活動列表</button>
										</div>
									</div>
								</div>
							</div>
						</div>

						<!-- 分票列表 -->
						<div class="tab-pane fade" id="ticket" role="tabpanel" aria-labelledby="ticket-tab">
							<div class="card">
								<div class="card-header">
									<h3 class="card-title">分票列表</h3>
								</div>
								<div class="card-body">
									<p>分票列表內容</p>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</main>
		<footer class="app-footer">
			<div class="float-end d-none d-sm-inline">TIA203-G2</div>
			<strong> Copyright &copy; 2025&nbsp; <a href="https://gamma.app/docs/TickEasy-gd84wknpd0a0roz?mode=doc"
					class="text-decoration-none">TickEasy</a>.
			</strong> All rights reserved.
		</footer>
	</div>
	<script src="https://code.jquery.com/jquery-3.7.1.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
	<!--begin::Third Party Plugin(OverlayScrollbars)-->
	<script src="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.10.1/browser/overlayscrollbars.browser.es6.min.js"
		integrity="sha256-dghWARbRe2eLlIJ56wNB+b760ywulqK3DzZYEpsg2fQ=" crossorigin="anonymous"></script>
	<!--end::Third Party Plugin(OverlayScrollbars)-->
	<!--begin::Required Plugin(popperjs for Bootstrap 5)-->
	<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
		integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
		crossorigin="anonymous"></script>
	<!--end::Required Plugin(popperjs for Bootstrap 5)-->
	<!--begin::Required Plugin(Bootstrap 5)-->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
		integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
		crossorigin="anonymous"></script>
	<!--end::Required Plugin(Bootstrap 5)-->
	<!--begin::Required Plugin(AdminLTE)-->
	<script src="../common/js/adminlte.js"></script>
	<!--end::Required Plugin(AdminLTE)-->
	<!-- OPTIONAL SCRIPTS -->
	<!--Summernote-->
	<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.20/dist/summernote-lite.min.js"></script>
	<!-- apexcharts -->
	<script src="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.min.js"
		integrity="sha256-+vh8GkaU7C9/wbSLIcwq82tQ2wTf44aOHA8HlBMwRI8=" crossorigin="anonymous"></script>

	<!--begin::OverlayScrollbars Configure & 換票列表管理功能-->
	<script>
		// OverlayScrollbars 設定
		const SELECTOR_SIDEBAR_WRAPPER = '.sidebar-wrapper';
		const Default = {
			scrollbarTheme: 'os-theme-light',
			scrollbarAutoHide: 'leave',
			scrollbarClickScroll: true,
		};

		// 換票列表管理功能 - 全域變數
		let currentPage = 1;
		let pageSize = 10;
		let searchParams = {};

		// DOM 元素快取
		const elements = {
			eventSelect: null,
			statusSelect: null,
			keywordInput: null,
			startDateInput: null,
			endDateInput: null,
			searchBtn: null,
			resetBtn: null,
			backBtn: null,
			tableBody: null,
			pagination: null
		};

		// DOM 載入完成後初始化
		document.addEventListener('DOMContentLoaded', function () {
			console.log('=== DOM 載入完成，開始初始化 ===');

			// 1. 初始化 OverlayScrollbars
			initOverlayScrollbars();

			// 2. 快取 DOM 元素
			cacheElements();

			// 3. 綁定事件
			bindEvents();

			// 4. 設定預設值
			setDefaultValues();

			// 5. 載入初始資料
			loadInitialData();
		});

		/**
		 * 初始化 OverlayScrollbars
		 */
		function initOverlayScrollbars() {
			const sidebarWrapper = document.querySelector(SELECTOR_SIDEBAR_WRAPPER);
			if (sidebarWrapper && typeof OverlayScrollbarsGlobal?.OverlayScrollbars !== 'undefined') {
				OverlayScrollbarsGlobal.OverlayScrollbars(sidebarWrapper, {
					scrollbars: {
						theme: Default.scrollbarTheme,
						autoHide: Default.scrollbarAutoHide,
						clickScroll: Default.scrollbarClickScroll,
					},
				});
			}
		}

		/**
		 * 快取 DOM 元素
		 */
		function cacheElements() {
			elements.eventSelect = document.getElementById('eventSelect');
			elements.statusSelect = document.getElementById('statusSelect');
			elements.keywordInput = document.getElementById('keywordInput');
			elements.startDateInput = document.getElementById('startDateInput');
			elements.endDateInput = document.getElementById('endDateInput');
			elements.searchBtn = document.getElementById('searchBtn');
			elements.resetBtn = document.getElementById('resetBtn');
			elements.backBtn = document.getElementById('backBtn');
			elements.tableBody = document.getElementById('exchangeTableBody');
			elements.pagination = document.getElementById('paginationContainer');
		}

		/**
		 * 綁定事件處理器
		 */
		function bindEvents() {
			console.log('=== 開始綁定事件 ===');

			// 搜尋按鈕事件
			if (elements.searchBtn) {
				elements.searchBtn.addEventListener('click', function (e) {
					e.preventDefault();
					console.log('搜尋按鈕被點擊');
					performSearch();
				});
			}

			// 活動選擇事件
			if (elements.eventSelect) {
				elements.eventSelect.addEventListener('change', function () {
					console.log('活動選擇改變:', this.value);
					performSearch();
				});
			}

			// 狀態選擇事件
			if (elements.statusSelect) {
				elements.statusSelect.addEventListener('change', function () {
					console.log('狀態選擇改變:', this.value);
					performSearch();
				});
			}

			// 重置按鈕事件
			if (elements.resetBtn) {
				elements.resetBtn.addEventListener('click', function () {
					console.log('重置按鈕被點擊');
					resetSearch();
				});
			}

			// 返回按鈕事件
			if (elements.backBtn) {
				elements.backBtn.addEventListener('click', function () {
					console.log('返回按鈕被點擊');
					window.location.href = './index.html';
				});
			}

			// 關鍵字輸入按Enter搜尋
			if (elements.keywordInput) {
				elements.keywordInput.addEventListener('keypress', function (e) {
					if (e.key === 'Enter') {
						e.preventDefault();
						console.log('Enter鍵被按下');
						performSearch();
					}
				});
			}

			// 日期變更事件
			if (elements.startDateInput) {
				elements.startDateInput.addEventListener('change', performSearch);
			}
			if (elements.endDateInput) {
				elements.endDateInput.addEventListener('change', performSearch);
			}

			console.log('=== 事件綁定完成 ===');
		}

		/**
		 * 設定預設值
		 */
		function setDefaultValues() {
			// 設定預設日期範圍（最近3個月）
			const today = new Date();
			const threeMonthsAgo = new Date(today.getFullYear(), today.getMonth() - 3, today.getDate());

			if (elements.startDateInput) {
				elements.startDateInput.value = formatDate(threeMonthsAgo);
			}
			if (elements.endDateInput) {
				elements.endDateInput.value = formatDate(today);
			}
		}

		/**
		 * 載入初始資料
		 */
		async function loadInitialData() {
			try {
				console.log('=== 開始載入初始資料 ===');

				// 依序載入資料
				await loadEventList();
				await loadSwapStatusList();

				// 最後載入交換列表
				await loadExchangeList();

			} catch (error) {
				console.error('載入初始資料失敗：', error);
				showError('載入初始資料失敗');
			}
		}

		/**
		 * 載入活動列表
		 */
		async function loadEventList() {
			try {
				console.log('=== 載入活動列表 ===');
				const response = await fetch('/maven-tickeasy-v1/api/manager/ticket-exchange/events');
				const result = await response.json();

				if (result.success && elements.eventSelect) {
					// 清空現有選項
					elements.eventSelect.innerHTML = '<option value="">全部活動</option>';

					// 添加活動選項
					result.data.forEach(event => {
						const option = document.createElement('option');
						option.value = event.eventId;
						option.textContent = event.eventName;
						elements.eventSelect.appendChild(option);
					});

					console.log('活動列表載入成功，共', result.data.length, '個活動');
				} else {
					console.error('載入活動列表失敗：', result.message);
				}
			} catch (error) {
				console.error('載入活動列表錯誤：', error);
			}
		}

		/**
		 * 載入換票狀態列表
		 */
		async function loadSwapStatusList() {
			try {
				console.log('=== 載入狀態列表 ===');
				const response = await fetch('/maven-tickeasy-v1/api/manager/ticket-exchange/swap-status');
				const result = await response.json();

				if (result.success && elements.statusSelect) {
					// 清空現有選項（保留預設選項）
					elements.statusSelect.innerHTML = '<option value="">全部</option>';

					// 添加狀態選項
					result.data.forEach(status => {
						const option = document.createElement('option');
						option.value = status.value;
						option.textContent = status.label;
						elements.statusSelect.appendChild(option);
					});

					console.log('狀態列表載入成功，共', result.data.length, '個狀態');
				} else {
					console.error('載入狀態列表失敗：', result.message);
				}
			} catch (error) {
				console.error('載入狀態列表錯誤：', error);
			}
		}

		/**
		 * 執行搜尋
		 */
		function performSearch() {
			console.log('=== 執行搜尋 ===');
			currentPage = 1;

			// 收集搜尋參數
			searchParams = {};

			// 關鍵字
			if (elements.keywordInput && elements.keywordInput.value.trim()) {
				searchParams.keyword = elements.keywordInput.value.trim();
			}

			// 活動ID
			if (elements.eventSelect && elements.eventSelect.value) {
				searchParams.eventId = parseInt(elements.eventSelect.value);
			}
			// 狀態
			if (elements.statusSelect && elements.statusSelect.value !== '') {
				searchParams.swappedStatus = parseInt(elements.statusSelect.value);
			}

			// 日期範圍
			if (elements.startDateInput && elements.startDateInput.value) {
				searchParams.startDate = elements.startDateInput.value;
			}
			if (elements.endDateInput && elements.endDateInput.value) {
				searchParams.endDate = elements.endDateInput.value;
			}

			console.log('搜尋參數：', searchParams);
			loadExchangeList();
		}

		/**
		 * 載入換票列表
		 */
		async function loadExchangeList() {
			try {
				console.log('=== 載入換票列表 ===');
				showLoading(true);

				// 建立查詢參數，只包含有值的參數
				const queryParams = {
					page: currentPage,
					size: pageSize
				};

				// 只添加有值的搜尋參數
				Object.keys(searchParams).forEach(key => {
					const value = searchParams[key];
					if (value !== null && value !== undefined && value !== '') {
						queryParams[key] = value;
					}
				});

				console.log('最終查詢參數：', queryParams);

				// 建立 URL 參數字串，過濾空值
				const params = new URLSearchParams();
				Object.entries(queryParams).forEach(([key, value]) => {
					if (value !== null && value !== undefined && value !== '') {
						params.append(key, value.toString());
					}
				});

				const url = `/maven-tickeasy-v1/api/manager/ticket-exchange/swaps?${params.toString()}`;
				console.log('請求 URL：', url);

				const response = await fetch(url);
				const result = await response.json();

				console.log('API 回應：', result);

				if (result.success) {
					renderExchangeTable(result.data.data);
					renderPagination(result.data);
				} else {
					showError('載入換票列表失敗：' + result.message);
				}
			} catch (error) {
				console.error('載入換票列表錯誤：', error);
				showError('載入換票列表時發生錯誤');
			} finally {
				showLoading(false);
			}
		}

		/**
		 * 渲染換票表格
		 */
		function renderExchangeTable(data) {
			console.log('=== 渲染表格資料 ===', data);

			if (!elements.tableBody) {
				console.error('找不到表格 body 元素');
				return;
			}

			if (!data || data.length === 0) {
				elements.tableBody.innerHTML = '<tr><td colspan="7" class="text-center">暫無數據</td></tr>';
				return;
			}

			const tableHTML = data.map(item => {
				console.log('處理項目：', item);
				return `
   				<tr>
   					<td>${item.commentId || '-'}</td>
   					<td>${item.commentTicketId || '-'}</td>
   					<td>${item.commentMemberId || '-'}</td>
   					<td>${item.postTicketId || '-'}</td>
   					<td>${item.postMemberId || '-'}</td>
   					<td>${formatDisplayTime(item)}</td>
   					<td>
   						<span class="badge ${getStatusBadgeClass(item.swappedStatus)}">
   							${getStatusText(item.swappedStatus)}
   						</span>
   					</td>
   				</tr>
   			`;
			}).join('');

			elements.tableBody.innerHTML = tableHTML;
			console.log('表格渲染完成');
		}

		/**
		 * 渲染分頁控制器
		 */
		function renderPagination(pageData) {
			console.log('=== 渲染分頁 ===', pageData);

			if (!elements.pagination) {
				console.error('找不到分頁容器元素');
				return;
			}

			const { currentPage: current, totalPages, hasPrevious, hasNext } = pageData;

			if (totalPages <= 1) {
				elements.pagination.innerHTML = '';
				return;
			}

			let paginationHTML = '';

			// 第一頁按鈕
			paginationHTML += `
   			<li class="page-item ${current === 1 ? 'disabled' : ''}">
   				<a class="page-link" href="#" onclick="goToPage(1)" ${current === 1 ? 'aria-disabled="true"' : ''}>第一頁</a>
   			</li>
   		`;

			// 上一頁按鈕
			paginationHTML += `
   			<li class="page-item ${!hasPrevious ? 'disabled' : ''}">
   				<a class="page-link" href="#" onclick="goToPage(${current - 1})" ${!hasPrevious ? 'aria-disabled="true"' : ''}>上一頁</a>
   			</li>
   		`;

			// 頁碼按鈕
			const startPage = Math.max(1, current - 2);
			const endPage = Math.min(totalPages, current + 2);

			for (let i = startPage; i <= endPage; i++) {
				paginationHTML += `
   				<li class="page-item ${i === current ? 'active' : ''}">
   					<a class="page-link" href="#" onclick="goToPage(${i})">${i}</a>
   				</li>
   			`;
			}

			// 下一頁按鈕
			paginationHTML += `
   			<li class="page-item ${!hasNext ? 'disabled' : ''}">
   				<a class="page-link" href="#" onclick="goToPage(${current + 1})" ${!hasNext ? 'aria-disabled="true"' : ''}>下一頁</a>
   			</li>
   		`;

			// 最末頁按鈕
			paginationHTML += `
   			<li class="page-item ${current === totalPages ? 'disabled' : ''}">
   				<a class="page-link" href="#" onclick="goToPage(${totalPages})" ${current === totalPages ? 'aria-disabled="true"' : ''}>最末頁</a>
   			</li>
   		`;

			elements.pagination.innerHTML = paginationHTML;
		}

		/**
		 * 跳轉到指定頁面
		 */
		function goToPage(page) {
			console.log('跳轉到頁面：', page);
			if (page < 1) return;
			currentPage = page;
			loadExchangeList();
		}

		/**
		 * 格式化顯示時間 - 根據狀態決定顯示哪個時間
		 */
		function formatDisplayTime(item) {
			let dateTime;
			// 如果是已換票狀態且有換票時間，顯示換票時間；否則顯示建立時間
			if (item.swappedStatus === 2 && item.swappedTime) {
				dateTime = item.swappedTime;
			} else {
				dateTime = item.createTime;
			}
			return formatDateTime(dateTime);
		}

		/**
		 * 獲取狀態文字
		 */
		function getStatusText(status) {
			const statusMap = {
				0: '待換票',
				1: '待確認',
				2: '已換票',
				3: '已取消'
			};
			return statusMap[status] || '未知';
		}

		/**
		 * 獲取狀態徽章樣式
		 */
		function getStatusBadgeClass(status) {
			const badgeMap = {
				0: 'bg-warning text-dark',
				1: 'bg-info',
				2: 'bg-success',
				3: 'bg-danger'
			};
			return badgeMap[status] || 'bg-secondary';
		}

		/**
		 * 格式化日期時間
		 */
		function formatDateTime(dateTime) {
			if (!dateTime) return '-';

			try {
				const date = new Date(dateTime);

				// 檢查日期是否有效
				if (isNaN(date.getTime())) {
					return '-';
				}

				const year = date.getFullYear();
				const month = String(date.getMonth() + 1).padStart(2, '0');
				const day = String(date.getDate()).padStart(2, '0');
				const hours = String(date.getHours()).padStart(2, '0');
				const minutes = String(date.getMinutes()).padStart(2, '0');

				return `${year}/${month}/${day} ${hours}:${minutes}`;
			} catch (error) {
				console.error('日期格式化錯誤：', error);
				return '-';
			}
		}

		/**
		 * 格式化日期（用於 input[type="date"]）
		 */
		function formatDate(date) {
			const year = date.getFullYear();
			const month = String(date.getMonth() + 1).padStart(2, '0');
			const day = String(date.getDate()).padStart(2, '0');
			return `${year}-${month}-${day}`;
		}

		/**
		 * 顯示載入狀態
		 */
		function showLoading(show) {
			if (show && elements.tableBody) {
				elements.tableBody.innerHTML = '<tr><td colspan="7" class="text-center"><div class="spinner-border spinner-border-sm me-2" role="status"></div>載入中...</td></tr>';
			}
		}

		/**
		 * 顯示錯誤訊息
		 */
		function showError(message) {
			console.error('錯誤：', message);

			// 移除現有的錯誤訊息
			const existingAlert = document.querySelector('.alert.alert-danger');
			if (existingAlert) {
				existingAlert.remove();
			}

			const alertHTML = `
   			<div class="alert alert-danger alert-dismissible fade show" role="alert">
   				<i class="bi bi-exclamation-triangle-fill"></i> ${message}
   				<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
   			</div>
   		`;

			const container = document.querySelector('.app-content .container-fluid');
			if (container) {
				container.insertAdjacentHTML('afterbegin', alertHTML);

				// 自動移除錯誤訊息
				setTimeout(() => {
					const alert = container.querySelector('.alert.alert-danger');
					if (alert) {
						alert.remove();
					}
				}, 5000);
			}
		}

		/**
		 * 顯示成功訊息
		 */
		function showSuccess(message) {
			// 移除現有的成功訊息
			const existingAlert = document.querySelector('.alert.alert-success');
			if (existingAlert) {
				existingAlert.remove();
			}

			const alertHTML = `
   			<div class="alert alert-success alert-dismissible fade show" role="alert">
   				<i class="bi bi-check-circle-fill"></i> ${message}
   				<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
   			</div>
   		`;

			const container = document.querySelector('.app-content .container-fluid');
			if (container) {
				container.insertAdjacentHTML('afterbegin', alertHTML);

				// 自動移除成功訊息
				setTimeout(() => {
					const alert = container.querySelector('.alert.alert-success');
					if (alert) {
						alert.remove();
					}
				}, 3000);
			}
		}

		/**
		 * 重置搜尋條件
		 */
		function resetSearch() {
			console.log('=== 重置搜尋條件 ===');

			// 清空表單欄位
			if (elements.keywordInput) elements.keywordInput.value = '';
			if (elements.statusSelect) elements.statusSelect.value = '';
			if (elements.eventSelect) elements.eventSelect.value = '';

			// 重設日期範圍
			setDefaultValues();

			// 清空搜尋參數
			searchParams = {};
			currentPage = 1;

			// 重新載入列表
			loadExchangeList();

			showSuccess('搜尋條件已重置');
		}

		/**
		 * 防抖函數 - 避免頻繁觸發搜尋
		 */
		function debounce(func, wait) {
			let timeout;
			return function executedFunction(...args) {
				const later = () => {
					clearTimeout(timeout);
					func(...args);
				};
				clearTimeout(timeout);
				timeout = setTimeout(later, wait);
			};
		}

		// 將需要全域存取的函數匯出
		window.goToPage = goToPage;
		window.resetSearch = resetSearch;

		// 為了向後相容，也提供舊的函數名稱
		window.performSearch = performSearch;
		window.loadExchangeList = loadExchangeList;

		console.log('=== 腳本載入完成 ===');
	</script>
</body>

</html>