<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>報名者列表測試頁面</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        padding: 2rem;
      }
      .container {
        max-width: 1200px;
      }
      .form-label {
        font-weight: bold;
      }
      .result-table th {
        white-space: nowrap;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="mb-4">報名者列表測試</h1>
      <p class="text-muted">
        本頁面用於測試 <code>ParticipantListController</code> (/participants)
        的功能。
      </p>

      <!-- 查詢表單 -->
      <div class="card mb-4">
        <div class="card-header">查詢條件</div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-3">
              <label for="eventId" class="form-label"
                >活動 ID (Event ID) *</label
              >
              <input
                type="number"
                class="form-control"
                id="eventId"
                placeholder="必填，例如 1"
              />
            </div>
            <div class="col-md-3">
              <label for="participantName" class="form-label">報名者姓名</label>
              <input
                type="text"
                class="form-control"
                id="participantName"
                placeholder="模糊查詢"
              />
            </div>
            <div class="col-md-3">
              <label for="email" class="form-label">Email</label>
              <input
                type="email"
                class="form-control"
                id="email"
                placeholder="模糊查詢"
              />
            </div>
            <div class="col-md-3">
              <label for="phone" class="form-label">電話</label>
              <input
                type="text"
                class="form-control"
                id="phone"
                placeholder="模糊查詢"
              />
            </div>
            <div class="col-md-4">
              <label for="ticketTypeId" class="form-label">票種</label>
              <select id="ticketTypeId" class="form-select">
                <option value="">所有票種</option>
                <!-- 選項將由 API 動態載入 -->
              </select>
            </div>
            <div class="col-md-4">
              <label for="status" class="form-label">票券狀態</label>
              <select id="status" class="form-select">
                <option value="">全部</option>
                <option value="1">有效</option>
                <option value="0">已取消</option>
                <!-- 根據您的業務邏輯調整 -->
              </select>
            </div>
            <div class="col-md-4">
              <label for="isUsed" class="form-label">是否已使用</label>
              <select id="isUsed" class="form-select">
                <option value="">全部</option>
                <option value="1">是</option>
                <option value="0">否</option>
              </select>
            </div>
          </div>
          <div class="mt-3">
            <button id="searchBtn" class="btn btn-primary">查詢</button>
            <button id="resetBtn" class="btn btn-secondary">重設</button>
          </div>
        </div>
      </div>

      <!-- 結果顯示區域 -->
      <div id="message" class="alert d-none" role="alert"></div>

      <h3 class="mt-4">查詢結果</h3>
      <div class="d-flex justify-content-between align-items-center mb-2">
        <span id="result-summary"></span>
        <div id="pagination" class="pagination-controls"></div>
      </div>

      <div class="table-responsive">
        <table
          class="table table-bordered table-striped table-hover result-table"
        >
          <thead>
            <tr>
              <th>#</th>
              <th>票券 ID</th>
              <th>報名者</th>
              <th>Email</th>
              <th>電話</th>
              <th>訂單 ID</th>
              <th>票種名稱</th>
              <th>票券狀態</th>
              <th>是否已使用</th>
            </tr>
          </thead>
          <tbody id="result-body">
            <tr>
              <td colspan="9" class="text-center">請輸入活動 ID 並點擊查詢</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <script>
      // --- DOM 元素 ---
      const eventIdInput = document.getElementById("eventId");
      const searchBtn = document.getElementById("searchBtn");
      const resetBtn = document.getElementById("resetBtn");
      const resultBody = document.getElementById("result-body");
      const messageDiv = document.getElementById("message");
      const paginationDiv = document.getElementById("pagination");
      const resultSummarySpan = document.getElementById("result-summary");
      const ticketTypeSelect = document.getElementById("ticketTypeId");

      // --- 狀態變數 ---
      let currentPage = 1;
      const pageSize = 10; // 與後端 DAO 的預設值保持一致
      let currentEventId = null;
      let ticketTypesLoaded = false;

      // --- 事件監聽 ---
      searchBtn.addEventListener("click", () => {
        currentPage = 1; // 每次新查詢都從第一頁開始
        ticketTypesLoaded = false; // 允許為新的 Event ID 重新載入票種
        ticketTypeSelect.innerHTML = '<option value="">所有票種</option>'; // 清空舊票種
        fetchParticipants();
      });

      resetBtn.addEventListener("click", () => {
        document
          .querySelector(".card-body")
          .querySelectorAll("input, select")
          .forEach((el) => {
            if (el.id !== "eventId") el.value = "";
          });
      });

      // --- 主要函式 ---
      async function fetchParticipants() {
        const eventId = eventIdInput.value;
        if (!eventId) {
          showMessage("請務必輸入活動 ID (Event ID)", "danger");
          return;
        }

        // 更新當前 Event ID
        currentEventId = eventId;

        // 收集所有查詢參數
        const params = new URLSearchParams({
          eventId: eventId,
          pageNumber: currentPage,
          pageSize: pageSize,
        });

        const participantName =
          document.getElementById("participantName").value;
        if (participantName) params.append("participantName", participantName);

        const email = document.getElementById("email").value;
        if (email) params.append("email", email);

        const phone = document.getElementById("phone").value;
        if (phone) params.append("phone", phone);

        const ticketTypeId = document.getElementById("ticketTypeId").value;
        if (ticketTypeId) params.append("ticketTypeId", ticketTypeId);

        const status = document.getElementById("status").value;
        if (status) params.append("status", status);

        const isUsed = document.getElementById("isUsed").value;
        if (isUsed) params.append("isUsed", isUsed);

        // 注意：請將 '/maven-tickeasy-v1' 替換成您專案的 context path
        const url = `/maven-tickeasy-v1/participants?${params.toString()}`;

        try {
          const response = await fetch(url);
          const result = await response.json();

          if (result.success) {
            showMessage(result.message, "success");
            renderTable(result.data.data);
            renderPagination(result.data.total);
            if (!ticketTypesLoaded) {
              populateTicketTypes(result.data.ticketTypes);
            }
          } else {
            showMessage(`查詢失敗: ${result.message}`, "danger");
            resultBody.innerHTML = `<tr><td colspan="9" class="text-center text-danger">${result.message}</td></tr>`;
            paginationDiv.innerHTML = "";
            resultSummarySpan.textContent = "";
          }
        } catch (error) {
          console.error("Fetch Error:", error);
          const fullUrl = new URL(url, window.location.origin).href;
          showMessage(
            `發送請求時發生錯誤，請檢查瀏覽器開發者工具(F12)的 Console 和 Network 分頁。錯誤: ${error.message} <br/>請求URL: ${fullUrl}`,
            "danger"
          );
        }
      }

      function renderTable(participants) {
        if (!participants || participants.length === 0) {
          resultBody.innerHTML =
            '<tr><td colspan="9" class="text-center">查無資料</td></tr>';
          return;
        }

        let html = "";
        participants.forEach((p, index) => {
          const statusText = p.status === 1 ? "有效" : "已取消";
          const isUsedText = p.isUsed === 1 ? "是" : "否";
          html += `
                    <tr>
                        <td>${(currentPage - 1) * pageSize + index + 1}</td>
                        <td>${p.ticketId}</td>
                        <td>${p.participantName || ""}</td>
                        <td>${p.email || ""}</td>
                        <td>${p.phone || ""}</td>
                        <td>${p.orderId}</td>
                        <td>${
                          p.eventTicketType
                            ? p.eventTicketType.categoryName
                            : "N/A"
                        }</td>
                        <td>${statusText}</td>
                        <td>${isUsedText}</td>
                    </tr>
                `;
        });
        resultBody.innerHTML = html;
      }

      function renderPagination(totalItems) {
        const totalPages = Math.ceil(totalItems / pageSize);
        paginationDiv.innerHTML = "";
        resultSummarySpan.textContent = `共 ${totalItems} 筆資料，目前在第 ${currentPage} / ${
          totalPages > 0 ? totalPages : 1
        } 頁`;

        if (totalPages <= 1) return;

        let paginationHtml = '<div class="btn-group">';

        // 上一頁按鈕
        const prevDisabled = currentPage === 1 ? "disabled" : "";
        paginationHtml += `<button class="btn btn-outline-secondary" ${prevDisabled} onclick="changePage(${
          currentPage - 1
        })">上一頁</button>`;

        // 下一頁按鈕
        const nextDisabled = currentPage === totalPages ? "disabled" : "";
        paginationHtml += `<button class="btn btn-outline-secondary" ${nextDisabled} onclick="changePage(${
          currentPage + 1
        })">下一頁</button>`;

        paginationHtml += "</div>";
        paginationDiv.innerHTML = paginationHtml;
      }

      function populateTicketTypes(ticketTypes) {
        if (!ticketTypes || ticketTypes.length === 0) {
          ticketTypesLoaded = true;
          return;
        }

        ticketTypes.forEach((type) => {
          const option = document.createElement("option");
          option.value = type.typeId;
          option.textContent = `${type.categoryName} (ID: ${type.typeId})`;
          ticketTypeSelect.appendChild(option);
        });
        ticketTypesLoaded = true;
      }

      function changePage(newPage) {
        currentPage = newPage;
        fetchParticipants();
      }

      function showMessage(msg, type = "info") {
        messageDiv.className = `alert alert-${type}`;
        messageDiv.innerHTML = msg;
        messageDiv.classList.remove("d-none");
      }
    </script>
  </body>
</html>
